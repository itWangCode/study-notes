# 执行上下文

[什么是执行上下文](https://juejin.cn/post/6844904158957404167#heading-5)

[JavaScript深入理解之执行上下文](http://cavszhouyou.top/JavaScript%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E4%B9%8B%E6%89%A7%E8%A1%8C%E4%B8%8A%E4%B8%8B%E6%96%87.html#more)

## 概念

JavaScript 引擎`在执行一段可执行代码之前`，会先进行准备工作，也就是对这段代码进行解析（也可以称为预处理）。这个 “准备工作”，就叫做 "执行上下文(execution context 简称 EC)" 或者也可以叫做执行环境。

执行上下文 为我们的可执行代码块提供了执行前的必要准备工作，例如变量对象的定义、作用域链的扩展、提供调用者的对象引用等信息。

这个阶段会根据可执行代码`创建相应的执行上下文`（ Execution Context ），也就是做声明提升等工作（后边会详细讲解）。然后在代码解析完成后才开始代码的执行

JavaScript 引擎解析执行代码的过程是一个边执行边解析的过程，解析发生在执行一段可执行代码之前。举个例子，当执行到一个函数的时候，就会先对这个函数进行解析，然后再执行这个函数。

## 可执行代码

在代码解析阶段会根据不同的可执行代码创建相应的执行上下文 ：

```
全局执行代码，在执行所有代码前，解析创建全局执行上下文。

函数执行代码，执行函数前，解析创建函数执行上下文。

eval执行代码，运行于当前执行上下文中。
```

## 执行上下文的组成

执行上下文定义了变量或函数有权访问的其他数据，决定了它们各自的行为。每一个执行上下文都由以下三个属性组成。

1. 变量对象（Variable object，VO）

2. 作用域链(Scope chain)

3. 调用者信息(this)

如果将上述一个完整的执行上下文使用代码形式表现出来的话，应该类似于下面这种：

```js
executionContext：{
  [variable object | activation object]：{
      arguments,
      variables: [...],
      funcions: [...]
  },
  scope chain: variable object + all parents scopes
  thisValue: context object
}
```

## 变量对象（variable object 简称 VO）

每个执行环境文都有一个表示变量的对象——变量对象，全局执行环境的变量对象始终存在，而函数这样局部环境的变量，只会在函数执行的过程中存在，在函数被调用时且在具体的`函数代码运行之前`，JS 引擎会用当前函数的`参数列表（arguments）`初始化一个 “变量对象” 并将当前执行上下文与之关联 ，函数代码块中声明的 `变量` 和 `函数` 将作为属性添加到这个变量对象上。

## 活动对象（activation object 简称 AO）

函数进入`执行阶段`时，原本不能访问的变量对象被激活成为一个活动对象，自此，我们可以访问到其中的各种属性。

其实变量对象和活动对象是一个东西，只不过处于不同的状态和阶段而已。

## 作用域链

[跳转作用域文档](./scope.md)

## 当前可执行代码块的调用者（this）

如果当前函数被作为对象方法调用或使用 bind call apply 等 API 进行委托调用，则将当前代码块的调用者信息（this value）存入当前执行上下文，否则默认为全局对象调用。

## 执行上下文栈

执行每一段可执行代码时都会对应创建一个执行上下文，那么我们是如何来管理这些执行上下文的呢？JavaScript 引擎创建了执行上下文栈（Execution context stack，ECS）来管理执行上下文。

JavaScript 开始要解释执行代码的时候，最先遇到的就是全局代码，所以 JavaScript 引擎会先解析创建全局执行上下文，然后将全局执行上下文压栈。然后当执行流进入一个函数时，会先解析创建函数的执行上下文，然后将它的执行上下文压栈。而在函数执行之后，会将其执行上下文弹栈，弹栈后执行上下文中所有的数据都会被销毁，然后把控制权返回给之前的执行上下文。注意，全局执行上下文会一直留在栈底，直到整个应用结束。

## ES3 执行上下文的生命周期

创建阶段
执行阶段
销毁阶段
