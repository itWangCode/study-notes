var gulp=require("gulp"),path=require("path"),fs=require("fs"),browserSync=require("browser-sync"),uglify=require("gulp-uglify"),wrapper=require("gulp-wrapper"),replace=require("gulp-replace"),projectConfig={name:"一匡-H5",author:"zlf",releasePath:"h5",cdnPath:"//app.asset3.com/equanta/",testPath:"//123.56.237.44/equanta/"},projectUtil={fomartPath:function(e){return e.replace(/\\/g,"/")},getCurrentDir:function(){return fs.realpathSync("./")},getSvnRoot:function(){var e=this.getCurrentDir(),t=e.replace(/develop\S*/g,"");return t=this.fomartPath(t)},getReleasePath:function(){var e=this.getSvnRoot(),t=projectConfig.releasePath;return path.join(e,"release",t)},getCDNpath:function(){return projectConfig.cdnPath+projectConfig.releasePath},getTestPath:function(){return projectConfig.testPath+projectConfig.releasePath},getNowDate:function(){var e=new Date;return now=e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate()+" "+e.getHours()+":"+e.getMinutes()+":"+e.getMinutes(),now},deleteDir:function(e){var t=this,p=[];fs.existsSync(e)&&(p=fs.readdirSync(e),p.forEach(function(p,s){var r=e+"/"+p;fs.statSync(r).isDirectory()?t.deleteDir(r):fs.unlinkSync(r)}),fs.rmdirSync(e))}};gulp.task("css",function(){gulp.src(["css/**/*.css","!css/**/*.min.css"]).pipe(wrapper({header:"/* @update: "+projectUtil.getNowDate()+" */ \n"})).pipe(gulp.dest("build/css"))}),gulp.task("js",function(){gulp.src(["js/**/*.js","!js/modules/**/*.*","!js/config.js"]).pipe(uglify({mangle:{except:["jQuery","$","require"]},output:{ascii_only:!0}})).pipe(wrapper({header:"/* @update: "+projectUtil.getNowDate()+" */ \n"})).pipe(gulp.dest("build/js")),gulp.src(["js/config.js"]).pipe(replace(/true/i,"false")).pipe(replace(/gulpTag/g,projectUtil.getCDNpath())).pipe(uglify({mangle:{except:["jQuery","$","require"]},output:{ascii_only:!0}})).pipe(wrapper({header:"/* @update: "+projectUtil.getNowDate()+" */ \n"})).pipe(gulp.dest("build/js"))}),gulp.task("js-m",function(){gulp.src(["js/**/*.js","!js/modules/**/*.*","!js/config.js"]).pipe(wrapper({header:"/* @update: "+projectUtil.getNowDate()+" */ \n"})).pipe(gulp.dest("build/js")),gulp.src(["js/config.js"]).pipe(replace(/true/i,"false")).pipe(replace(/gulpTag/g,projectUtil.getTestPath())).pipe(wrapper({header:"/* @update: "+projectUtil.getNowDate()+" */ \n"})).pipe(gulp.dest("build/js"))}),gulp.task("html",function(){gulp.src(["html/**/*.html","html/**/*.htm"]).pipe(replace(/href="..\/css/g,'href="'+projectUtil.getCDNpath()+"/css")).pipe(replace(/src="..\/js/g,'src="'+projectUtil.getCDNpath()+"/js")).pipe(replace(/src="..\/images/g,'src="'+projectUtil.getCDNpath()+"/images")).pipe(replace(/src="..\/css/g,'src="'+projectUtil.getCDNpath()+"/css")).pipe(replace(/url\(..\/images/g,"url("+projectUtil.getCDNpath()+"/images")).pipe(replace(/lazyload="..\/images/g,'lazyload="'+projectUtil.getCDNpath()+"/images")).pipe(gulp.dest("build/html"))}),gulp.task("html-m",function(){gulp.src(["html/**/*.html","html/**/*.htm"]).pipe(replace(/href="..\/css/g,'href="'+projectUtil.getTestPath()+"/css")).pipe(replace(/src="..\/js/g,'src="'+projectUtil.getTestPath()+"/js")).pipe(replace(/src="..\/images/g,'src="'+projectUtil.getTestPath()+"/images")).pipe(replace(/src="..\/css/g,'src="'+projectUtil.getTestPath()+"/css")).pipe(replace(/url\(..\/images/g,"url("+projectUtil.getTestPath()+"/images")).pipe(replace(/lazyload="..\/images/g,'lazyload="'+projectUtil.getTestPath()+"/images")).pipe(gulp.dest("build/html"))}),gulp.task("moveFiles",function(){gulp.src(["css/**/*.png","css/**/*.jpg","css/**/*.gif"]).pipe(gulp.dest("build/css")),gulp.src(["css/fonts/*"]).pipe(gulp.dest("build/css/fonts")),gulp.src(["css/sprite/**/*.png","css/sprite/**/*.jpg","css/sprite/**/*.gif"]).pipe(gulp.dest("build/css/sprite")),gulp.src(["images/**/*.png","images/**/*.jpg","images/**/*.gif"]).pipe(gulp.dest("build/images")),gulp.src(["data/*.*"]).pipe(gulp.dest("build/data"))}),gulp.task("deleteBuild",function(){projectUtil.deleteDir("build")}),gulp.task("releaseBuild",function(){projectUtil.deleteDir(projectUtil.getReleasePath()),gulp.src(["build/css/**/*.*"]).pipe(gulp.dest(projectUtil.getReleasePath()+"/css")),gulp.src(["build/html/**/*.*"]).pipe(gulp.dest(projectUtil.getReleasePath()+"/html")),gulp.src(["build/js/**/*.*"]).pipe(gulp.dest(projectUtil.getReleasePath()+"/js")),gulp.src(["build/images/**/*.*"]).pipe(gulp.dest(projectUtil.getReleasePath()+"/images"))}),gulp.task("build",function(){gulp.run(["deleteBuild","css","js","moveFiles","html"])}),gulp.task("build-m",function(){gulp.run(["deleteBuild","css","js-m","moveFiles","html-m"])}),gulp.task("release",function(){gulp.run(["releaseBuild"])}),gulp.task("server",function(){var e=["**/**/*.*"];browserSync.init(e,{server:{baseDir:"./",directory:!0}})});var transport=require("gulp-seajs-transport");gulp.task("trans",function(){projectUtil.deleteDir("js/dist"),gulp.src("js/modules/**/*.js").pipe(transport()).pipe(replace(/(123.56.237.44:8080)/,"app.asset3.com")).pipe(replace(/define\(\"/g,'define("dist/')).pipe(gulp.dest("js/dist"))}),gulp.task("trans-m",function(){projectUtil.deleteDir("js/dist"),gulp.src("js/modules/**/*.js").pipe(transport()).pipe(replace(/define\(\"/g,'define("dist/')).pipe(gulp.dest("js/dist"))});