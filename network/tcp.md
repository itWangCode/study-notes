# TCP/IP

通常使用的网络是在TCP/IP协议族的基础上运作的，而HTTP属于它内部的一个子集。

TCP/IP是互联网相关的各类协议族的总称:IP,PPPoE,DNS,UDP,FTP,SNMP,HTTP,FDDI,ICMP,IEEE 802.3,

利用TCP/IP协议族进行网络通信时，会通过分层顺序与对方进行通信。发送端从应用层往下走，接收端从链路层往上走。

IP协议的作用是把各种数据包传送给对方。

ARP是一种用以解析地址的协议，根据通信方的IP地址就可以反查对应的MAC地址。

## TCP/IP协议族层次

按层次分别分为以下4层：

应用层：应用层决定了向用户提供应用服务时通信的活动。TCP/IP协议族内预存了各类通用的应用服务。比如：[FTP DNS HTTP SMTP POP3 SSH]

传输层：传输层对上层应用层，提供处于网络链接中的两台计算机之间的数据传输。有两个性质不同的协议 [TCP UDP]

网络层：网络层用来处理网络上流动的数据包，数据包是网络传输的最小数据单位。该层规定了通过怎样的路径到达对方计算机，并把数据包传送给对方。[IP ICMP ARP RARP]

数据链路层: 用来处理链接网络的硬件部分。包括控制操作系统，硬件的设备驱动，NIC，及光纤等物理可见部分。硬件上的范畴均在链路层的作用范围之内。

## TCP协议

<https://www.jianshu.com/p/ef892323e68f>

IP：负责联网主机之间的路由选择和寻址
TCP:负责在不可靠的传输信道上提供可靠的抽象层。

HTTP可以用TCP传输协议或者其他，例如UDP协议

TCP 协议是面向连接的，提供可靠数据传输服务的传输层协议。

特点：

TCP 协议是面向连接的，在通信双方进行通信前，需要通过三次握手建立连接。它需要在端系统中维护双方连接的状态信息。

TCP 协议通过序号、确认号、定时重传、检验和等机制，来提供可靠的数据传输服务。

TCP 协议提供的是点对点的服务，即它是在单个发送方和单个接收方之间的连接。

TCP 协议提供的是全双工的服务，也就是说连接的双方的能够向对方发送和接收数据。

TCP 提供了拥塞控制机制，在网络拥塞的时候会控制发送数据的速率，有助于减少数据包的丢失和减轻网络中的拥塞程度。

TCP 提供了流量控制机制，保证了通信双方的发送和接收速率相同。如果接收方可接收的缓存很小时，发送方会降低发送 速率，避免因为缓存填满而造成的数据包的丢失。

## TCP三次握手

确保数据能到达目标，TCP协议采用了三次握手策略 :

syn ：（序号），SYNchronize

ack ：（确认号），acknowledgement number

1. 第一次握手：客户端发送syn包(syn=j)到服务器，并进入SYN_SEND状态，等待服务器确认；

2. 第二次握手：服务器收到syn包，必须确认客户的SYN（ack=j+1），同时自己也发送一个SYN包（syn=k），即SYN+ACK包，此时服务器进入SYN_RECV状态；

3. 第三次握手：客户端收到服务器的SYN＋ACK包，向服务器发送确认包ACK(ack=k+1)，此包发送完毕，客户端和服务器进入ESTABLISHED状态，完成三次握手。

握手过程中传送的包里不包含数据，三次握手完毕后，客户端与服务器才正式开始传送数据。理想状态下，TCP连接一旦建立，在通信双方中的任何一方主动关闭连接之前，TCP 连接都将被一直保持下去。断开连接时服务器和客户端均可以主动发起断开TCP连接的请求，断开过程需要经过“四次握手”（过程就不细写了，就是服务器和客户端交互，最终确定断开）

### 为什么要三次握手

防止已失效的连接请求又传送到服务器端，因而产生错误

防止其中一方停止发送后，另一方持续等待。

## rwnd

接收窗口: 发送端和接收端的接收窗口大小，包含能够保存数据的缓冲区空间大小的信息。

## 拥塞控制

<https://zhuanlan.zhihu.com/p/76023663>

窗口缩放: TCP Window Scaling

只要网络中没有出现拥塞，拥塞窗口的值就可以再增大一些，以便把更多的数据包发送出去，但只要网络出现拥塞，拥塞窗口的值就应该减小一些，以减少注入到网络中的数据包数。

目前 Linux 内核默认的 Reno 算法和 Google 的 BBR 算法进行说明，其中基于丢包的拥塞控制算法 Reno 由于非常著名，所以常常作为教材的重点说明对象。

Reno 被许多教材（例如：《计算机网络——自顶向下的方法》）所介绍，适用于低延时、低带宽的网络，它将拥塞控制的过程分为四个阶段：慢启动、拥塞避免、快重传和快恢复

### cwnd

congestion window

拥塞窗口大小: 发送端对从客户端接收确认（ACK）之前可以发送数据量的限制。

### 阶段一：慢启动

指数增加传递cwnd

慢启动阶段思路是不要一开始就发送大量的数据，先探测一下网络的拥塞程度，也就是说由小到大逐渐增加拥塞窗口的大小，在没有出现丢包时每收到一个 ACK 就将拥塞窗口大小加一（单位是 MSS，最大单个报文段长度），每轮次发送窗口增加一倍，呈指数增长，若出现丢包，则将拥塞窗口减半，进入拥塞避免阶段；

### 阶段二：拥塞避免

算法是为了避免可能发生的拥塞，将发送窗口的大小由每过一个 RTT 增长一倍，变为每过一个 RTT ，长度只加一。 这样将窗口的增长速率由指数增长，变为加法线性增长。

### 阶段三：快速重传

指的是，当发送方收到三个冗余的确认应答时，因为 TCP 使用的是累计确认的机制，所以很有可能是发生了报文段的 丢失，因此采用立即重传的机制，在定时器结束前发送所有已发送但还未接收到确认应答的报文段。

### 阶段四：快速恢复

是对快速重传的后续处理，因为网络中可能已经出现了拥塞情况，所以会将慢启动的阀值减小为原来的一半，然后将拥 塞窗口的值置为减半后的阀值，然后开始执行拥塞避免算法，使得拥塞窗口缓慢地加性增大。简单来理解就是，乘性减，加性增。

TCP 认为网络拥塞的主要依据是报文段的重传次数，它会根据网络中的拥塞程度，通过调整慢启动的阀值，然后交替使用上面四 种机制来达到拥塞控制的目的。

### BBR

是谷歌在 2016 年提出的一种新的拥塞控制算法，已经在 Youtube 服务器和谷歌跨数据中心广域网上部署，据 Youtube 官方数据称，部署 BBR 后，在全球范围内访问 Youtube 的延迟降低了 53%，在时延较高的发展中国家，延迟降低了 80%。

## 流量控制/滑动窗口

<https://blog.csdn.net/wdscq1234/article/details/52444277>

## 带宽延迟积

BDP:数据链路的容量与其端到端延迟的乘积。这个结果就是任意时刻处于在途未确认状态的最大数据量。

## 队首阻塞

按序交付和可靠交付的时候，TCP不是必要的选择。会导致额外的延迟，对性能造成负面影响。

无需按序交付数据或能够处理分组丢失的应用程序，以及对延迟或者抖动要求很高的应用程序，最好选择UDP等协议。

## TCP优化

TCP三次握手增加了整整一次往返时间

TCP慢启动讲被应用到每个新链接

TCP流量及拥塞控制会影响所有链接的吞吐量

TCP的吞吐量由当前拥塞窗口大小控制

### 服务器配置调优

让服务器跟上时代是优化发送端和接收端的首要措施

优化项：

1. 增大TCP的初始拥塞窗口
2. 慢启动重启：在连接空闲时，禁用慢启动可以改善瞬时发送数据的长TCP连接的性能。
3. 窗口缩放(RFC1332):启用窗口缩放可以增大最大接收窗口大小，可以让高延迟的连接增加吞吐量。

### TCP快速打开

### 应用程序行为调优

再快也快不过什么也不用发送，能少发就少发

我们不能让数据传输的更快，但可以让他们传输的距离更短

重用TCP连接是提升性能的关键，

### 检查清单

1. 把服务器内核升级到最新版本
2. 确保cwnd大小为10
3. 禁用空闲后的慢启动
4. 确保启动窗口缩放
5. 减少传输冗余数据
6. 压缩要传输的数据
7. 把服务器放到离用户近的地方以减少往返时间
8. 尽最大可能重用已经建立的TCP连接。
